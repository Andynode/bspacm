<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>BSPACM: BSPACM Coding Style</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">BSPACM
   &#160;<span id="projectnumber">20140424</span>
   </div>
   <div id="projectbrief">Board Support Package for ARM Cortex-M Microcontrollers</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">BSPACM Coding Style </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#coding_style">Indentation and Syntactic Style</a></li>
<li class="level1"><a href="#coding_naming">Identifiers and Naming Conventions</a></li>
<li class="level1"><a href="#coding_types">Type Selection</a></li>
<li class="level1"><a href="#coding_misc">Miscellaneous</a><ul><li class="level2"><a href="#coding_misc_yoda">Comparison Operands</a></li>
<li class="level2"><a href="#coding_misc_rv">Function Return Values</a></li>
<li class="level2"><a href="#coding_misc_incl">Include Files</a><ul><li class="level3"><a href="#coding_misc_incl_protection">Protection Against Nested Inclusion</a></li>
<li class="level3"><a href="#coding_misc_incl_use">Standard Order for Include Files</a></li>
</ul>
</li>
<li class="level2"><a href="#coding_misc_cpp">Preprocessor Feature Tests</a></li>
</ul>
</li>
<li class="level1"><a href="#coding_doc">Documentation Expectations</a></li>
</ul>
</div>
<div class="textblock"><p>The coding style for BSPACM is primarily the one the author converged to over the last twenty-five years, but has a few lingering influences from <a href="http://pabigot.github.io/bsp430">BSP430</a>.</p>
<h1><a class="anchor" id="coding_style"></a>
Indentation and Syntactic Style</h1>
<p>BSPACM's coding style may be obtained using the following Emacs <a href="http://cc-mode.sourceforge.net/">ccmode</a> style:</p>
<div class="fragment"><div class="line">(c-add-style <span class="stringliteral">&quot;pab&quot;</span></div>
<div class="line">         <span class="stringliteral">&#39;(&quot;gnu&quot;</span></div>
<div class="line"><span class="stringliteral">           (indent-tabs-mode . nil) ; No tabs in the source</span></div>
<div class="line"><span class="stringliteral">           (c-offsets-alist</span></div>
<div class="line"><span class="stringliteral">        (case-label . 2)    ; Indent the case labels</span></div>
<div class="line"><span class="stringliteral">        )))</span></div>
</div><!-- fragment --><p>An acceptably close approximation can be had using the following <a href="http://astyle.sourceforge.net/">Artistic Style (astyle)</a> command line:</p>
<div class="fragment"><div class="line">astyle \</div>
<div class="line">  --options=none \</div>
<div class="line">  --style=1tbs \</div>
<div class="line">  --indent=spaces=2 \</div>
<div class="line">  --indent-switches \</div>
<div class="line">  --pad-header \</div>
<div class="line">  --max-instatement-indent=60 \</div>
<div class="line">  -r \</div>
<div class="line">    <span class="stringliteral">&#39;*.c&#39;</span> \</div>
<div class="line">    <span class="stringliteral">&#39;*.h&#39;</span> \</div>
<div class="line">    <span class="stringliteral">&#39;*.inc&#39;</span></div>
</div><!-- fragment --><p>Where astyle and emacs reformat the other's code, astyle's decision is preferred.</p>
<p>Note in particular that the one-true-brace-style expects single statements in loop, <code>if</code> and <code>else</code> bodies to be enclosed in braces, e.g.:</p>
<div class="fragment"><div class="line"><span class="keywordflow">if</span> (condition) {</div>
<div class="line">  f1();</div>
<div class="line">} <span class="keywordflow">else</span> {</div>
<div class="line">  f2();</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="coding_naming"></a>
Identifiers and Naming Conventions</h1>
<p>Care is taken in BSPACM to conform to the rules for C regarding global identifiers. In particular, underscores may not appear at the start of an identifier (including macro parameters), and certain suffixes like <code>_t</code> are reserved.</p>
<ul>
<li>All global symbols and macros encode that they are part of BSPACM by beginning with <code>BSPACM</code> with or without prefix characters that indicate type information. The next section of the identifier encodes information about the BSPACM module to which it belongs.</li>
</ul>
<ul>
<li>Macros are upper-case, underscore separated.</li>
</ul>
<ul>
<li>Function names are intercapped. An initial letter indicates the return type: <code>i</code> is used for <code>int</code>, <code>ul</code> for <code>unsigned long</code>, <code>v</code> for <code>void</code>, and <code>h</code> for a pointer-to-structure (for example, used as a device handle). The letter <code>x</code> is used as a prefix for more complex types, such as <code>const char *</code>, other pointers, and structures.</li>
</ul>
<ul>
<li>Type names (tags and typedefs) are intercapped. An initial letter distinguishes the "type" of type: <code>s</code> is a <code>struct</code>, <code>u</code> is a <code>union</code>, <code>e</code> is an <code>enum</code>. <code>h</code> indicates a handle for (pointer to) a structure type. <code>f</code> is used for a typedef describing a function prototype. <code>t</code> is used for any typedef for a scalar type.</li>
</ul>
<ul>
<li>Where user code may define or reference instances of a BSPACM <code>struct</code>, <code>union</code>, and <code>enum</code> type directly (i.e. not through a handle), those types should have typedef aliases that use the tag as the type name.</li>
</ul>
<ul>
<li>Enumeration values are intercapped and begin with <code>e</code>.</li>
</ul>
<ul>
<li>A concept of "protected" is indicated by a single trailing underscore. Generally this is used in macro parameters, static storage class variables, and structure fields that should not be accessed by user code directly implementation.</li>
</ul>
<ul>
<li>Global variables (e.g., state for device peripherals) follow the general convention of function names.</li>
</ul>
<ul>
<li>Function parameters, structure/union member tags, local variables, and file static variables should be lower case, underscore separated. These identifiers do not encode type information.</li>
</ul>
<ul>
<li>Where a function or value has an associated physical unit that is required for correct interpretation of the value, the unit should be expressed as an underscore-separated suffix consistent with the <a href="http://unitsofmeasure.org/">Unified Code for Units of Measure</a>. As an example, all BSPACM frequency values are annotated with the suffix <code>_Hz</code>.</li>
</ul>
<h1><a class="anchor" id="coding_types"></a>
Type Selection</h1>
<p>Anybody using a Cortex-M device should know that they are operating on a 32-bit device, and BSPACM is by design restricted to Cortex-M devices.</p>
<ul>
<li>Except where a data type is used as part of an interface to an external system or to reflect a specific intent, <code>int</code> and <code>unsigned int</code> are used in preference to size-explicit types for index variables, return values, etc. This follows POSIX API standards.</li>
</ul>
<ul>
<li><code>uint32_t</code> is the core type for reference to system and peripheral memory mapped registers, even though <a href="https://launchpad.net/gcc-arm-embedded">some toolchains</a> (ahem) typedef this to <code>unsigned long</code> when it could just as well be <code>unsigned int</code>. This follows ARM standards.</li>
</ul>
<ul>
<li>Smaller sized types (<code>uint16_t</code>, <code>int8_t</code>, etc) are used in preference to <code>short</code> and <code>char</code> for integral values where space is at a premium and the values will never exceed the type used. Generally this applies only to stored data, but may also occur in temporary values used in expression evaluation, to make any truncation explicit.</li>
</ul>
<ul>
<li>C language <code>short</code> and <code>long</code> integer types are not used directly.</li>
</ul>
<ul>
<li>ASCII text characters and strings use <code>char</code> as the core type. <code>char</code> is not used for non-text data.</li>
</ul>
<ul>
<li>For consistency with POSIX APIs, pointers to data buffers are usually pointers to <code>void</code>, though in some cases they may be pointers to <code>uint8_t</code> to eliminate the need for casts when operating on octet data.</li>
</ul>
<ul>
<li>Any parameter that is a pointer to data the function is expected not to modify should include the appropriate <code>const</code> qualifier.</li>
</ul>
<h1><a class="anchor" id="coding_misc"></a>
Miscellaneous</h1>
<h2><a class="anchor" id="coding_misc_yoda"></a>
Comparison Operands</h2>
<p>BSPACM places comparison operands which are lvalues on the right side of the operator, as with:</p>
<div class="fragment"><div class="line"><span class="keywordflow">if</span> (4 &lt;= len) {</div>
<div class="line">  <span class="comment">/* Too long */</span></div>
<div class="line">}</div>
</div><!-- fragment --><p>Yes, even if the conditional operator "couldn't possibly be mistyped" as an assignment operator. <a href="http://www.dodgycoder.net/2011/11/yoda-conditions-pokemon-exception.html">Up with it you must put.</a></p>
<h2><a class="anchor" id="coding_misc_rv"></a>
Function Return Values</h2>
<p>Where a function implements an operation that may succeed or fail, that state reflected in the return value following standard POSIX conventions: a zero indicates a successful execution and a negative value indicates an error. Where useful information about a successful result may be expressed as a non-negative value (e.g., the number of bytes successfully transmitted), that may be included in the return value.</p>
<p>This is often counter-intuitive to programmers unfamiliar with POSIX, but the correct test to see whether the I2C addresses were successfully set is indeed:</p>
<div class="fragment"><div class="line"><span class="keywordflow">if</span> (0 == iBSPACMserialI2CsetAddresses_rh(i2c, oa, sa)) {</div>
<div class="line">  <span class="comment">/* Success here... */</span></div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="coding_misc_incl"></a>
Include Files</h2>
<h3><a class="anchor" id="coding_misc_incl_protection"></a>
Protection Against Nested Inclusion</h3>
<p>Be aware that in BSPACM a generic header such as &lt;<a class="el" href="led_8h.html" title="Generic interface to LEDs. ">bspacm/utility/led.h</a>&gt; will in turn include a device-specific &lt;bspacm/utility/led_.h&gt; to complete the necessary data structures and inline function definitions. This file is located by compiler flags that provide a prioritized list of locations to look for that file.</p>
<p>Include file protection symbols encode the path by which the include file is normally accessed, preceded by components from its containing path if appropriate, with non-alphanumeric characters replaced by underscores, and the resulting token expressed in upper case. For example, the generic header &lt;<a class="el" href="led_8h.html" title="Generic interface to LEDs. ">bspacm/utility/led.h</a>&gt; is located at <code>$(BSPACM_ROOT)/include/bspacm/utility/led.h</code> and is protected with:</p>
<div class="fragment"><div class="line"><span class="preprocessor"> #ifndef BSPACM_UTILITY_LED_H #define BSPACM_UTILITY_LED_H </span><span class="comment">/*</span></div>
<div class="line"><span class="comment">... */</span><span class="preprocessor"> </span><span class="comment">/* Provide device-specific information */</span><span class="preprocessor"> #include</span></div>
<div class="line"><span class="preprocessor">&lt;bspacm/utility/led_.h&gt; #endif </span><span class="comment">/* BSPACM_UTILITY_LED_H */</span><span class="preprocessor"> </span></div>
</div><!-- fragment --><p>When compiling for an EFM32 device the reference to &lt;bspacm/utility/led_.h&gt; will find the header located at <code>$(BSPACM_ROOT)/device/efm32/include/bspacm/utility/led_.h</code>, and its include protection symbol is:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#ifndef BSPACM_DEVICE_EFM32_INTERNAL_UTILITY_LED_H</span></div>
<div class="line"><span class="preprocessor">#define BSPACM_DEVICE_EFM32_INTERNAL_UTILITY_LED_H</span></div>
<div class="line"><span class="comment">/* ... */</span></div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* BSPACM_DEVICE_EFM32_INTERNAL_UTILITY_LED_H */</span><span class="preprocessor"></span></div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd>Because this header is for internal use, its base name ends with an underscore. To avoid violation of the C rule that consecutive underscores in identifiers are reserved for the implementation, the protection symbol instead inserts the sequence <code>_INTERNAL</code> between the device-specific path and the relative name.</dd></dl>
<h3><a class="anchor" id="coding_misc_incl_use"></a>
Standard Order for Include Files</h3>
<p>See also bspacm_config for naming conventions and standards related overriding default configurations.</p>
<dl class="section user"><dt>Header Files (*.h)</dt><dd></dd></dl>
<p>Every header file that does not include another BSPACM header file must include &lt;<a class="el" href="core_8h.html" title="Common header included by all BSPACM leaf headers. ">bspacm/core.h</a>&gt; first to ensure the necessary preprocessor directives that are affected by &lt;<a class="el" href="config_8h.html" title="Application/board-specific header. ">bspacm/config.h</a>&gt; are applied in the standard order.</p>
<p>&lt;<a class="el" href="core_8h.html" title="Common header included by all BSPACM leaf headers. ">bspacm/core.h</a>&gt; may be expected to include the following external material:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;stdint.h&gt;</span>             <span class="comment">/* Size-annotated integral types (uint8_t) */</span></div>
<div class="line"><span class="preprocessor">#include &lt;stddef.h&gt;</span>             <span class="comment">/* NULL and size_t */</span></div>
<div class="line"><span class="preprocessor">#include &lt;bspacm/device.h&gt;</span>      <span class="comment">/* device-specific header */</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="config_8h.html">bspacm/config.h</a>&gt;</span>      <span class="comment">/* application-specific header */</span></div>
</div><!-- fragment --><p>The files &lt;bspacm/device.h&gt; and &lt;<a class="el" href="config_8h.html" title="Application/board-specific header. ">bspacm/config.h</a>&gt; do not exist in the primary include directory, but in alternative hierarchies placed within the device and board subdirectories. &lt;<a class="el" href="config_8h.html" title="Application/board-specific header. ">bspacm/config.h</a>&gt; in particular may also be superseded through use of an application-specific include hierarchy.</p>
<dl class="section user"><dt>Implementation Files (*.c)</dt><dd></dd></dl>
<p>Every implementation file should include &lt;<a class="el" href="core_8h.html" title="Common header included by all BSPACM leaf headers. ">bspacm/core.h</a>&gt; first to ensure that platform-specific overrides have been evaluated and are available to override defaults in other headers.</p>
<h2><a class="anchor" id="coding_misc_cpp"></a>
Preprocessor Feature Tests</h2>
<p>See also bspacm_config for naming conventions and standards related to feature tests.</p>
<p>Where a macro value is used for conditional compilation, the state of being true is determined with the following pattern:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#if (FEATURE_FLAG - 0)</span></div>
<div class="line"><span class="comment">/* Feature is enabled */</span></div>
<div class="line"><span class="preprocessor">#else </span><span class="comment">/* MACRO_VALUE */</span><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* Feature is not enabled */</span></div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* MACRO_VALUE */</span><span class="preprocessor"></span></div>
</div><!-- fragment --><p>This technique allows use of:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#define FEATURE_FLAG 0</span></div>
</div><!-- fragment --><p>to denote that the feature is being explicitly disabled. Developers of application or infrastructure code should ensure that any feature test flag has a definition to either 1 or 0 (or to an expression that will evaluate to either a true or false value when used within a preprocessor condition). The documentation explicitly marks macro definitions that are expected to have such values with the <code>@cppflag</code> annotation in the documentation block, which will produce:</p>
<dl class="section user"><dt>C Preprocessor Only:</dt><dd>This macro may have a value that restricts its use to C preprocessor conditional directives.</dd></dl>
<dl class="section note"><dt>Note</dt><dd>While other macros may be documented to have true or false values that are valid in both code and preprocessor expressions, macros with the <code>@cppflag</code> may have values that include preprocessor operators like <code>defined</code> which restrict their use to preprocessor directives.</dd></dl>
<p>The ability to explicitly disable features that default to being enabled is critical and requires a value-based comparison. The subtraction of 0 in the conditional expression allows syntactic correctness when somebody inappropriately defines the feature flag with no value: such a case is equivalent to disabling the feature. For consistency these tests should be enclosed in parentheses. The syntax also makes clear that the code was not intended to be <code>#ifdef FEATURE_FLAG</code>.</p>
<dl class="section warning"><dt>Warning</dt><dd>When features identified with null macro definitions are processed according to the BSPACM standard conditional directives, they are interpreted as being turned off, not on.</dd></dl>
<p>The correct way of detecting features when interoperating with external libraries using the null-definition style is:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#if defined(FEATURE_FLAG)</span></div>
<div class="line"><span class="comment">/* Function is available and feature is enabled */</span></div>
<div class="line"><span class="preprocessor">#else </span><span class="comment">/* FEATURE */</span><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* Function is missing or feature is disabled */</span></div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* FEATURE */</span><span class="preprocessor"></span></div>
</div><!-- fragment --><p>The short-hand <code>#ifdef</code> may be used instead of the <code>defined()</code> test if no further conditions are required, but is discouraged for consistency.</p>
<h1><a class="anchor" id="coding_doc"></a>
Documentation Expectations</h1>
<p>BSPACM uses <a href="http://www.doxygen.org/">Doxygen</a> for architectural and API documentation. The following macros are used in API documentation to highlight expectations of particular macros, variables, and functions.</p>
<p>Copyright 2014, Peter A. Bigot </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Thu Apr 24 2014 10:01:18 for BSPACM by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.6
</small></address>
</body>
</html>
